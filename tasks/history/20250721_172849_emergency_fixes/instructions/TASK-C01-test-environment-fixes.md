# TASK-C01: テスト環境緊急修正 - 実行安定性・カバレッジ向上

## 🚨 緊急修正タスク概要

**Priority**: 🔴 **Critical**  
**Impact**: テスト実行安定性向上 (70% → 90%+) + カバレッジ基盤確立  
**Timeline**: 48時間以内必須  
**Worker Role**: テスト環境修正専門

## 🎯 修正対象・詳細項目

### **修正対象ファイル**

#### 1. **vitest.config.ts** - タイムアウト・カバレッジ設定追加
```typescript
現状問題:
- デフォルトタイムアウト: 5秒 (統合テストで60-90秒必要)
- カバレッジ設定: 未実装
- 長時間テスト: 30%失敗率
- パフォーマンステスト: タイムアウトエラー多発

修正効果:
- テスト安定性: 70% → 90%+
- カバレッジ可視化: 0% → 100%
- 長時間テスト: 安定実行可能
```

#### 2. **TypeScript設定整合性修正**
```typescript
問題:
- tsconfig.json: CommonJS設定
- プロジェクト: ESM実行
- 設定不整合によるコンパイルエラー

修正効果:
- TypeScriptコンパイル: 安定化
- ESM-CommonJS整合性: 確保
- ビルド・テスト: 統一環境
```

#### 3. **Playwright競合問題解決**
```javascript
問題:
- "Target page, context or browser has been closed"
- ブラウザセッション競合
- 並列実行時のリソース競合

修正効果:
- ブラウザセッション: 安定管理
- 並列実行: 競合回避
- テスト信頼性: 大幅向上
```

## 🛠️ 実行手順

### **Phase 1: 現状問題詳細分析**
1. **Readツール**で設定ファイル詳細読み込み
   - vitest.config.ts
   - tsconfig.json
   - package.json (テストスクリプト部分)
   - vitest.setup.ts
2. **テスト実行**: `pnpm test` での現状問題確認
3. **エラーログ分析**: 具体的失敗原因の特定

### **Phase 2: vitest.config.ts最適化**

#### **追加すべき設定**
```typescript
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    // 基本設定
    environment: 'node',
    globals: true,
    
    // ファイル対象
    include: ['tests/**/*.test.ts'],
    exclude: [
      '**/node_modules/**', 
      '**/dist/**',
      '**/tasks/**'
    ],
    
    // タイムアウト設定（重要）
    timeout: 120000,        // 全体タイムアウト: 2分
    testTimeout: 90000,     // 個別テスト: 90秒
    hookTimeout: 60000,     // フック: 60秒
    
    // 並列実行制御
    threads: false,         // Playwright競合回避
    maxConcurrency: 1,      // 統合テストは順次実行
    
    // カバレッジ設定
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      reportsDirectory: './coverage',
      exclude: [
        'tests/',
        'dist/',
        '**/*.d.ts',
        'tasks/',
        'scripts/'
      ],
      include: ['src/**/*.ts']
    },
    
    // セットアップ
    setupFiles: './vitest.setup.ts'
  }
})
```

### **Phase 3: TypeScript設定整合性修正**

#### **tsconfig.json確認・修正提案**
```json
確認項目:
- module: "ESNext" または "NodeNext"
- target: "ES2022" 以上
- moduleResolution: "Node16" または "NodeNext"
- esModuleInterop: true

修正が必要な場合の提案:
- ESM対応設定への統一
- テスト実行環境との整合性確保
```

### **Phase 4: Playwright競合問題解決**

#### **vitest.setup.ts強化**
```typescript
追加すべき設定:
- グローバルタイムアウト設定
- Playwrightブラウザプール管理
- テスト間リソースクリーンアップ
- 並列実行制御

具体的実装:
- beforeAll/afterAll統一化
- ブラウザインスタンス管理
- ページセッション分離
```

### **Phase 5: テスト実行・検証**
1. **修正後テスト実行**: `pnpm test` での安定性確認
2. **カバレッジ確認**: `pnpm test:coverage` での可視化確認
3. **長時間テスト**: 60-90秒テストの成功率確認
4. **並列実行**: 複数テスト同時実行の安定性確認

## ⚠️ 重要な制約・注意事項

### **🚫 修正制限**
- **テストロジック変更禁止**: テスト内容・期待値の変更は禁止
- **破壊的変更禁止**: 既存テストが実行不可になる変更は禁止
- **設定ファイルのみ**: vitest.config.ts、tsconfig.json、vitest.setup.tsのみ

### **✅ 修正基準**
- **最小変更**: 問題解決に必要最小限の設定変更
- **後方互換性**: 既存テストの動作保証
- **標準準拠**: Vitest・TypeScriptのベストプラクティス準拠

### **📂 出力管理規則**
- **設定修正**: 元ファイルに直接修正実行
- **カバレッジレポート**: ./coverage/ ディレクトリ生成可
- **報告書**: `tasks/20250721_172849_emergency_fixes/reports/REPORT-C01-test-environment-fixes.md`

## 📋 成果物要件

### **修正成果物**
1. **vitest.config.ts** - タイムアウト・カバレッジ設定完全版
2. **tsconfig.json** - ESM整合性確保（修正が必要な場合のみ）
3. **vitest.setup.ts** - Playwright競合回避・強化版

### **検証成果物**
1. **テスト実行レポート**: 修正前後の成功率比較
2. **カバレッジレポート**: 初回カバレッジデータ生成
3. **パフォーマンス評価**: 長時間テストの安定実行確認

### **品質確認項目**
- [ ] テスト成功率: 70% → 90%+ 達成
- [ ] 長時間テスト: 60-90秒テストの安定実行
- [ ] カバレッジ可視化: HTMLレポート生成成功
- [ ] Playwright競合: エラー解消確認
- [ ] TypeScript整合性: コンパイルエラー解消

### **報告書内容**
1. **修正詳細**: 各設定ファイルの変更内容・理由
2. **検証結果**: テスト実行・カバレッジ・パフォーマンス評価
3. **改善効果**: 安定性向上・効率化の定量評価
4. **追加推奨**: さらなる改善提案（実装不要、提案のみ）

## 🎯 期待される効果

### **即時効果**
- **テスト安定性**: 70% → 90%+
- **実行時間**: タイムアウトエラー撲滅
- **カバレッジ可視化**: 0% → 100% (レポート生成)
- **開発体験**: テスト実行の信頼性確保

### **継続効果**  
- **品質保証**: 継続的なカバレッジ監視基盤
- **回帰防止**: 安定したテスト環境による回帰検出
- **開発効率**: テスト実行の高速化・信頼性向上
- **新機能開発**: テスト駆動開発の基盤確立

## 🔧 実行後の品質チェック

### **必須確認項目**
1. **テスト実行**: `pnpm test` が90%+成功率で完了
2. **カバレッジ**: `pnpm test:coverage` でHTMLレポート生成
3. **長時間テスト**: 統合テストが安定して90秒以内で完了
4. **並列実行**: 複数テストの同時実行が競合なく動作

### **成功基準**
- **✅ 安定性向上**: テスト成功率90%+達成
- **✅ タイムアウト解消**: 長時間テストの安定実行
- **✅ カバレッジ確立**: HTMLカバレッジレポート生成成功
- **✅ 競合解消**: Playwrightエラーの完全撲滅

## 📊 改善効果測定

### **修正前現状**
```yaml
テスト環境状況:
  成功率: ~70%
  主要問題: タイムアウト・Playwright競合
  カバレッジ: 未計測
  実行時間: 120秒+ (タイムアウト発生)
  安定性: 低
```

### **修正後目標**
```yaml
テスト環境目標:
  成功率: 90%+
  主要問題: 解消済み
  カバレッジ: HTMLレポート生成・可視化
  実行時間: 60-90秒 (安定範囲)
  安定性: 高
```

## 🌟 追加推奨事項（実装対象外）

### **将来改善提案**
1. **CI/CD統合**: GitHub Actions統合によるテスト自動化
2. **品質ゲート**: カバレッジ閾値によるコミット制限
3. **パフォーマンス監視**: テスト実行時間の継続監視
4. **並列実行最適化**: テスト分割による高速化

---

**重要**: この修正により、TradingAssistantXのテスト環境が安定化し、継続的品質保証の基盤が確立されます。

**実行担当**: Worker C  
**完了期限**: 48時間以内  
**次ステップ**: 修正完了後、Worker A/Bとの統合確認・全体テスト実行