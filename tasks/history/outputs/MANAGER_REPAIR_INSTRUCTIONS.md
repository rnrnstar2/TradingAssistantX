# TradingAssistantX ワークフロー修復指示書

**🎯 Manager:** rnrnstar  
**📅 発行日:** 2025-07-21  
**🔥 緊急度:** 高  

## 🚨 修復対象問題概要

システム調査により以下の重大不備を確認：
1. **アカウント情報の重複取得** (2-4回重複実行)
2. **ファイルサイズ監視の重複実行** (起動時+定期監視)  
3. **「缶失」誤字問題** (3箇所)
4. **セッション管理の非効率性** (ポーリング待機・リソース浪費)
5. **エラーハンドリング重複コード** (4箇所で同一検証)

## 👥 Worker分担戦略

### 🔧 **Worker 1: 即座対応タスク**
**専門分野:** 簡単修正・誤字修正  
**作業時間:** 15-30分  

**対象:**
- ✅ 「缶失」→「欠失」誤字修正（3箇所）
- ✅ ログ出力メッセージの最適化

---

### ⚙️ **Worker 2: 中優先度修正**
**専門分野:** システム監視・設定修正  
**作業時間:** 45-60分  

**対象:**
- ✅ ファイルサイズ監視重複実行修正
- ✅ エラーハンドリング重複コード統一  
- ✅ バッチ処理効率化

---

### 🏗️ **Worker 3: 構造的改善**
**専門分野:** アーキテクチャ修正・高難易度  
**作業時間:** 90-120分  

**対象:**  
- ✅ アカウント情報重複取得の根本修正
- ✅ セッション管理効率化
- ✅ キャッシュ機能実装

---

## 📋 詳細作業指示

### 🔧 **Worker 1 指示書**

#### **Task 1-1: 誤字修正**
**ファイル:** `src/utils/monitoring/health-check.ts`  
**修正箇所:**
- 行158: `'⚠️ [ファイル缶失]` → `'⚠️ [ファイル欠失]`
- 行176: `'📝 [オプションファイル] ${optionalMissing}件のオプションファイルが缶失（正常）'` → `'📝 [オプションファイル] ${optionalMissing}件のオプションファイルが欠失（正常）'`
- 行194: `// その他の必須ファイルの50%以上が缶失した場合` → `// その他の必須ファイルの50%以上が欠失した場合`

#### **Task 1-2: ログメッセージ最適化**
**対象:** 過剰なデバッグログの削減
- セッション統計ログを本番環境で抑制
- 不要な毎秒ログ出力の最適化

**完了確認:** 
```bash
grep -r "缶失" src/ # 0件であることを確認
pnpm dev # ログ出力が適切化されたことを確認
```

---

### ⚙️ **Worker 2 指示書**

#### **Task 2-1: ファイルサイズ監視重複修正**
**ファイル:** `src/core/autonomous-executor.ts`  
**修正内容:**
- 行76-77: コンストラクタでの即座実行削除
- 行1596: 初期化時の即座実行をオプション化
- 定期監視のみ実行する設計に変更

#### **Task 2-2: エラーハンドリング統一化**  
**ファイル:** `src/lib/playwright-account-collector.ts`
**修正内容:**
- 行192-194, 261-264, 353-356, 479-483の重複検証ロジックを統一メソッド化
- `isPageClosed()`共通メソッドの作成
- 各Safe関数での共通呼び出しに統一

**完了確認:**
```bash
pnpm build # ビルド成功確認
pnpm test # テスト成功確認  
```

---

### 🏗️ **Worker 3 指示書**

#### **Task 3-1: アカウント情報重複取得修正**
**最重要修正** - システム効率30-50%改善見込み

**修正箇所:**
- `src/core/autonomous-executor.ts` 行206, 1183, 1343, 1407
- `src/lib/playwright-account-collector.ts` 行586-587

**設計方針:**
1. アカウント情報キャッシュ機能実装（有効期限5分）
2. `analyzeCurrentStatus()`を一元化し、キャッシュ優先実行
3. 重複呼び出し検出・防止機能追加

#### **Task 3-2: セッション管理効率化**
**ファイル:** `src/lib/playwright-browser-manager.ts`

**修正内容:**
1. 行148-166: ポーリング待機をイベント通知ベースに変更
2. 行131-143: セッション解放の即座クリーンアップ実装
3. 行171-185: セッション検証の効率化

**実装要件:**
- EventEmitterベースのセッション管理
- キューイング機能付きセッション待機
- リソース即座解放機能

**完了確認:**
```bash  
pnpm dev # 2重実行がないことを確認
pnpm test:integration # 統合テスト成功確認
```

---

## 🎯 作業進行管理

### **並列作業計画**
```
Phase 1 (並列): Worker 1 + Worker 2 同時実行 (60分)  
Phase 2 (継続): Worker 3 構造的改善 (120分)
Phase 3 (統合): Manager 品質確認・統合 (30分)
```

### **品質確認チェックリスト**
- [ ] 誤字修正完了確認
- [ ] ファイルサイズ監視正常化
- [ ] アカウント情報重複取得解消
- [ ] セッション管理効率化
- [ ] 全テスト成功
- [ ] ビルド成功
- [ ] ログ出力最適化

### **成功指標**
- 🎯 システム実行時間30%削減
- 🎯 重複処理完全除去  
- 🎯 リソース使用量50%削減
- 🎯 ログ出力品質向上

---

## 🚨 緊急時対応

各Workerで問題発生時：
1. **即座報告** - 他Workerとの依存関係を考慮
2. **Manager相談** - 技術的判断が必要な場合  
3. **ロールバック準備** - git stash / commit 事前実行

**Manager最終責任:** すべての修正統合・品質確保・リリース判断

---

**📞 連絡手段:** Claude セッション内でリアルタイム報告・相談