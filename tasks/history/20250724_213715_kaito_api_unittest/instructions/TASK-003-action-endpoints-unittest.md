# TASK-003: src/kaito-api/endpoints/action-endpoints.ts 単体テスト作成

## 🎯 **タスク概要**

**対象ファイル**: `src/kaito-api/endpoints/action-endpoints.ts`
**出力先**: `tests/kaito-api/endpoints/`
**優先度**: 最高（MVP主要機能）

ActionEndpointsクラスの完全な単体テストを作成し、教育的投稿システムの動作確実性を保証する。

## 📋 **実装対象**

### テスト対象クラス・機能
1. **ActionEndpoints**
   - 教育的投稿作成機能
   - 教育的リツイート機能
   - 教育的いいね機能
   - 基本的な投稿・エンゲージメント機能
   - 画像アップロード機能
   - 頻度制御・スパム検出機能

2. **教育的価値検証システム**
   - コンテンツバリデーション
   - 教育キーワード検出
   - 禁止キーワード検出
   - 品質スコア計算

3. **頻度制御システム**
   - 投稿頻度チェック（30分間隔）
   - リツイート頻度チェック（10分間隔）
   - いいね頻度チェック（2分間隔）

## 🧪 **テスト仕様**

### ファイル構成
```
tests/kaito-api/endpoints/
├── action-endpoints.test.ts              # メインテストファイル
├── educational-content.test.ts           # 教育的コンテンツ機能テスト
├── content-validation.test.ts            # コンテンツ検証機能テスト
├── frequency-control.test.ts             # 頻度制御機能テスト
├── spam-detection.test.ts                # スパム検出機能テスト
└── action-endpoints-integration.test.ts  # 統合テスト
```

### テストケース設計

#### 教育的投稿作成テスト (`createEducationalPost`)
- **正常系**:
  - 教育キーワード含む投稿の成功
  - 適切な品質スコア計算
  - 投稿時間の更新確認
  - 教育的価値情報の正確性

- **異常系**:
  - 空コンテンツでの投稿失敗
  - 教育的価値不足での拒否
  - 禁止キーワード含む投稿拒否
  - 頻度制限による投稿拒否
  - スパム検出による投稿拒否

- **境界値テスト**:
  - 最小文字数（10文字）での動作
  - 教育キーワード境界での品質スコア
  - 頻度制限境界での動作

#### 教育的リツイート機能テスト (`retweetEducationalContent`)
- **正常系**:
  - 教育的価値のあるコンテンツのリツイート成功
  - リツイート時間の更新
  - 教育的理由の生成確認

- **異常系**:
  - 教育的価値不足コンテンツの拒否
  - 頻度制限（10分間隔）による拒否
  - 不正なtweetIdでの失敗

- **頻度制御テスト**:
  - 10分未満でのリツイート拒否
  - 10分経過後のリツイート成功
  - 頻度制限メッセージの正確性

#### 教育的いいね機能テスト (`likeEducationalContent`)
- **正常系**:
  - 高品質教育コンテンツへのいいね成功
  - いいね時間の更新
  - 教育的正当化理由の生成

- **異常系**:
  - 品質スコア50未満での拒否
  - 頻度制限（2分間隔）による拒否
  - 教育的価値不足での拒否

- **品質閾値テスト**:
  - 品質スコア49での拒否
  - 品質スコア50での成功
  - 品質スコア計算の正確性

#### コンテンツ検証機能テスト (`validateEducationalContent`)
- **教育キーワード検出テスト**:
  - 基本教育キーワードの検出
  - 大文字小文字の不一致での検出
  - 複数キーワード含む場合の処理
  - キーワードなしでの低スコア

- **禁止キーワード検出テスト**:
  - スパムキーワードの検出と拒否
  - 品質スコア0への変更
  - 適切なエラーメッセージ生成

- **品質スコア計算テスト**:
  - 教育キーワードありでのスコア60
  - 教育キーワードなしでのスコア20
  - 禁止キーワードでのスコア0
  - 短すぎるコンテンツでのスコア0

#### 頻度制御機能テスト (`checkPostingFrequency`)
- **投稿頻度制御テスト**:
  - 30分間隔の正確な計算
  - 初回投稿での制限なし
  - 30分未満での制限適用
  - 30分経過後の制限解除

- **待機時間計算テスト**:
  - 残り待機時間の正確性
  - 次回許可時間の計算
  - ミリ秒単位の精度確認

#### スパム検出機能テスト (`detectSpam`)
- **繰り返し文字検出**:
  - 20文字以上の同一文字繰り返し検出
  - 正常な繰り返し（20文字未満）の許可
  - 異なる文字での繰り返しの許可

- **装飾文字検出**:
  - 20個以上の装飾文字での検出
  - 正常な装飾文字使用の許可
  - 装飾文字カウントの正確性

#### 基本機能テスト（既存機能保持）
- **投稿機能** (`createPost`):
  - 基本的な投稿実行
  - MVPレベルの動作確認

- **エンゲージメント機能** (`performEngagement`):
  - like/retweet/unllike/unretweetの実行
  - 基本的なレスポンス生成

- **画像アップロード** (`uploadMedia`):
  - メディアIDの生成
  - メディアタイプの処理

#### 互換性メソッドテスト
- **execution-flow.ts互換メソッド**: 
  - `post()`, `retweet()`, `like()`の動作確認
  - レスポンス形式の統一性確認

- **メトリクス取得**:
  - `getPostingStatistics()`の正確性
  - `getExecutionMetrics()`の基本データ

## 🔧 **技術要件**

### テストフレームワーク
- **Jest**: メインテストフレームワーク
- **@types/jest**: TypeScript対応
- **jest-environment-node**: Node.js環境

### モック戦略
1. **時間制御**: 
   - `Date.now()`のモック化
   - `setTimeout`の制御（頻度テスト用）

2. **HTTP通信**: 
   - 基本的なHTTPクライアントのモック
   - 成功・失敗レスポンスの制御

3. **外部依存**: 
   - ActionEndpointsの依存関係最小化
   - 必要に応じたコンストラクタ引数モック

### 型安全性
- **教育的結果型**: `EducationalTweetResult`, `EducationalRetweetResult`, `EducationalLikeResult`
- **検証結果型**: `ContentValidation`, `FrequencyCheck`
- **基本レスポンス型**: `PostResponse`, `EngagementResponse`

## 📊 **品質基準**

### カバレッジ要件
- **行カバレッジ**: 95%以上
- **分岐カバレッジ**: 90%以上（教育的価値判定の全分岐）
- **関数カバレッジ**: 100%（全public/privateメソッド）

### 教育的機能品質
- **キーワード検出精度**: 100%（定義されたキーワードの完全検出）
- **品質スコア精度**: 期待値との完全一致
- **頻度制御精度**: 時間計算の正確性（ミリ秒レベル）

## 🚀 **実装手順**

### Phase 1: 基本機能テスト
1. **ActionEndpoints基本テスト**
   - 初期化・基本設定確認
   - 既存機能（post, engagement, upload）テスト

2. **コンテンツ検証機能テスト**
   - 教育キーワード検出テスト
   - 禁止キーワード検出テスト
   - 品質スコア計算テスト

### Phase 2: 教育的機能テスト
3. **教育的投稿機能テスト**
   - 正常系・異常系の完全テスト
   - 品質スコア連携テスト

4. **教育的エンゲージメント機能テスト**
   - リツイート・いいね機能テスト
   - 頻度制御連携テスト

### Phase 3: 制御・統合機能テスト
5. **頻度制御・スパム検出テスト**
   - 時間ベース制御テスト
   - スパム検出ロジックテスト

6. **統合・互換性テスト**
   - 全機能連携テスト
   - execution-flow.ts互換性確認

## ⚠️ **重要な制約**

### MVP制約遵守
- **教育的価値最優先**: 教育的価値検証機能の確実な動作確保
- **シンプル実装**: 現在のロジックをテストする最小限実装
- **統計機能禁止**: 高度な分析・レポート機能は作成しない

### 教育的価値制約
- **キーワードベース検証**: 定義されたキーワードリストに基づく検証
- **固定スコア計算**: 現在の簡単なスコア計算ロジックの保持
- **頻度制限遵守**: 設定された間隔の厳格な適用

### ファイル制約
- **出力先**: `tests/kaito-api/endpoints/`配下のみ
- **命名規則**: `*.test.ts`形式
- **依存最小化**: action-endpoints.ts以外への依存最小化

## 📝 **成果物**

### 必須ファイル
1. `tests/kaito-api/endpoints/action-endpoints.test.ts` - メインテストスイート
2. `tests/kaito-api/endpoints/educational-content.test.ts` - 教育機能専用テスト
3. `tests/kaito-api/endpoints/content-validation.test.ts` - コンテンツ検証テスト
4. `tests/kaito-api/endpoints/frequency-control.test.ts` - 頻度制御テスト
5. `tests/kaito-api/endpoints/spam-detection.test.ts` - スパム検出テスト
6. `tests/kaito-api/endpoints/action-endpoints-integration.test.ts` - 統合テスト

### テスト実行確認
- 全教育的機能の正常動作確認
- 頻度制御の正確な動作確認
- スパム検出機能の動作確認
- execution-flow.ts互換性の確認

## 🎯 **完了判定基準**

- [ ] 教育的投稿作成機能が完全にテストされている
- [ ] 教育的リツイート・いいね機能がテストされている
- [ ] コンテンツ検証（キーワード検出・品質スコア）が正確
- [ ] 頻度制御（30分・10分・2分間隔）が正確に動作
- [ ] スパム検出機能が適切に動作
- [ ] 既存機能の互換性が保持されている
- [ ] カバレッジ要件が達成されている
- [ ] TypeScript strict mode対応完了

**完了時は `tasks/20250724_213715_kaito_api_unittest/reports/REPORT-003-action-endpoints-unittest.md` に報告書を作成してください。**