# TASK-002: src/kaito-api/core/config.ts 単体テスト作成

## 🎯 **タスク概要**

**対象ファイル**: `src/kaito-api/core/config.ts`
**出力先**: `tests/kaito-api/core/`
**優先度**: 最高（MVP核心機能）

KaitoAPIConfigManagerクラスの完全な単体テストを作成し、設定管理機能の確実性を保証する。

## 📋 **実装対象**

### テスト対象クラス・機能
1. **KaitoAPIConfigManager**
   - 環境別設定生成（dev/staging/prod）
   - 設定検証とバリデーション
   - エンドポイントURL構築
   - セキュリティ設定管理
   - パフォーマンス設定最適化

2. **ユーティリティ関数**
   - `createDefaultConfig()` - デフォルト設定生成
   - `validateKaitoConfig()` - 設定検証
   - `buildApiEndpoint()` - エンドポイントURL構築

3. **プライベートヘルパーメソッド**
   - 環境別URL取得
   - セキュアキー生成
   - 暗号化キー生成
   - チェックサム生成

## 🧪 **テスト仕様**

### ファイル構成
```
tests/kaito-api/core/
├── config.test.ts              # メインテストファイル
├── config-manager.test.ts      # KaitoAPIConfigManager専用テスト
├── config-validation.test.ts   # 設定検証専用テスト
├── config-utilities.test.ts    # ユーティリティ関数テスト
└── config-security.test.ts     # セキュリティ機能テスト
```

### テストケース設計

#### KaitoAPIConfigManager基本機能テスト
- **初期化テスト**:
  - 正常な初期化
  - エンドポイント設定の初期化確認
  - デフォルト状態の確認

- **設定生成テスト（dev環境）**:
  - dev環境設定の正確性
  - APIベースURL確認
  - タイムアウト設定（10000ms）
  - リトライ設定（最大5回）
  - QPS制限（100）
  - ログレベル（debug）
  - モック有効化確認

- **設定生成テスト（staging環境）**:
  - staging環境設定の正確性
  - 適切なAPI URL
  - 中間的な設定値確認
  - ログレベル（info）

- **設定生成テスト（prod環境）**:
  - prod環境設定の正確性
  - 本番API URL使用
  - 厳格なタイムアウト（5000ms）
  - 制限されたリトライ回数（3回）
  - 最大QPS（200）
  - セキュリティ設定有効化
  - 暗号化有効化
  - 監査ログ有効化
  - 実API有効化

#### 設定検証機能テスト
- **正常な設定の検証**:
  - 有効な設定での検証成功
  - エラー・警告なしの確認
  - バリデーション結果の正確性

- **API設定エラー検証**:
  - baseURLが空の場合
  - HTTPS以外のURLの場合
  - 不正なタイムアウト値
  - 範囲外のQPS設定

- **認証設定エラー検証**:
  - 空のプライマリキー
  - 短すぎるキー（32文字未満）
  - 本番環境での暗号化無効化

- **警告レベル検証**:
  - 推奨範囲外のタイムアウト
  - 異常なQPS設定
  - 本番環境での監査ログ無効

#### エンドポイントURL構築テスト
- **正常なURL構築**:
  - userカテゴリのエンドポイント
  - tweetカテゴリのエンドポイント
  - engagementカテゴリのエンドポイント
  - authカテゴリのエンドポイント
  - healthエンドポイント

- **パラメータ置換テスト**:
  - `{userId}`パラメータ置換
  - `{tweetId}`パラメータ置換
  - 複数パラメータの同時置換
  - パラメータなしURL構築

- **エラーケーステスト**:
  - 不正なカテゴリ指定
  - 存在しないエンドポイント
  - 未初期化状態でのURL構築
  - 必要パラメータの不足

#### セキュリティ機能テスト
- **セキュアキー生成テスト**:
  - 64文字のキー生成確認
  - 文字セットの正確性
  - ランダム性の確認（複数回生成での差異）
  - 特殊文字を含まないことの確認

- **暗号化キー生成テスト**:
  - 64文字のキー生成確認
  - 特殊文字を含む文字セット
  - ランダム性の確認
  - セキュアキーとの差異確認

- **チェックサム生成テスト**:
  - 同一設定での同一チェックサム
  - 設定変更でのチェックサム変更
  - チェックサムの16進数形式確認
  - チェックサム計算の一意性

## 🔧 **技術要件**

### テストフレームワーク
- **Jest**: メインテストフレームワーク
- **@types/jest**: TypeScript対応
- **jest-environment-node**: Node.js環境テスト

### モック戦略
1. **process.env**: 環境変数のモック化
   - `KAITO_API_TOKEN`のテスト用設定
   - 環境別の動作確認

2. **Date**: 時間依存処理のモック化
   - チェックサム生成テスト
   - タイムスタンプ確認

3. **Math.random()**: セキュアキー生成テスト用
   - 予測可能な値での動作確認
   - ランダム性テスト

### 型安全性確認
- **設定オブジェクト型**: KaitoAPIConfig準拠
- **検証結果型**: ConfigValidationResult準拠
- **エンドポイント設定型**: EndpointConfig準拠

## 📊 **品質基準**

### カバレッジ要件
- **行カバレッジ**: 95%以上
- **分岐カバレッジ**: 90%以上
- **関数カバレッジ**: 100%（全public/privateメソッド）

### 設定品質確認
- **環境別設定の正確性**: dev/staging/prod設定値確認
- **セキュリティ設定の妥当性**: 本番環境での厳格な設定
- **パフォーマンス設定の適切性**: 環境別の最適化確認

## 🚀 **実装手順**

### Phase 1: 基本機能テスト
1. **KaitoAPIConfigManager基本テスト**
   - 初期化・設定生成テスト
   - 環境別設定の正確性確認

2. **設定検証機能テスト**
   - 正常系・異常系バリデーション
   - エラー・警告メッセージ確認

### Phase 2: 高度機能テスト
3. **エンドポイントURL構築テスト**
   - URL構築ロジック確認
   - パラメータ置換機能テスト

4. **セキュリティ機能テスト**
   - キー生成・チェックサム機能
   - セキュリティ設定確認

### Phase 3: ユーティリティ・統合テスト
5. **ユーティリティ関数テスト**
   - createDefaultConfig()
   - validateKaitoConfig()
   - buildApiEndpoint()

6. **統合テスト**
   - 全機能の連携動作確認
   - エラーハンドリング統合テスト

## ⚠️ **重要な制約**

### MVP制約遵守
- **シンプル実装**: 現在のconfig.tsをテストする最小限の実装
- **過剰テスト禁止**: 将来拡張を想定したテストは作成しない
- **統計機能禁止**: 設定使用状況等の分析機能は作成しない

### 実データ制約
- **実環境設定**: 本番環境設定の実際の値をテスト
- **セキュリティ考慮**: APIキー等の機密情報は適切にモック化
- **環境変数適切処理**: テスト環境での環境変数管理

### ファイル制約
- **出力先**: `tests/kaito-api/core/`配下のみ
- **命名規則**: `config*.test.ts`形式
- **依存関係**: config.ts以外への依存最小化

## 📝 **成果物**

### 必須ファイル
1. `tests/kaito-api/core/config.test.ts` - メインテストスイート
2. `tests/kaito-api/core/config-manager.test.ts` - ConfigManager専用テスト
3. `tests/kaito-api/core/config-validation.test.ts` - バリデーション専用テスト
4. `tests/kaito-api/core/config-utilities.test.ts` - ユーティリティテスト
5. `tests/kaito-api/core/config-security.test.ts` - セキュリティテスト

### テスト実行確認
- 全テストの成功実行
- TypeScript strict mode対応
- ESLint/Prettier適合
- 設定生成・検証・URL構築の全機能動作確認

## 🎯 **完了判定基準**

- [ ] 全設定生成パターン（dev/staging/prod）がテストされている
- [ ] 設定検証の全エラー・警告ケースがカバーされている
- [ ] エンドポイントURL構築が全カテゴリでテストされている
- [ ] セキュリティ機能（キー生成・チェックサム）がテストされている
- [ ] ユーティリティ関数が完全にテストされている
- [ ] カバレッジ要件が達成されている
- [ ] TypeScript型安全性が確保されている

**完了時は `tasks/20250724_213715_kaito_api_unittest/reports/REPORT-002-core-config-unittest.md` に報告書を作成してください。**