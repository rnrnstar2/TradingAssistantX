# TASK-006: 最終調整とドキュメント整合性確認

## 📋 タスク概要
Claudeテストの実装を完成させるための最終調整を行い、ドキュメントとコードの整合性を確認する。

## 🎯 目的
- 実装とドキュメントの整合性を確保
- テストカバレッジの確認
- エラーハンドリングの最終確認
- 不要なコメントやデバッグコードの削除

## 📁 対象ファイル
- `src/claude/endpoints/*.ts` - 全エンドポイントファイル
- `docs/claude.md` - ドキュメント
- `tests/claude/**/*.test.ts` - 全テストファイル

## 🔧 実装詳細

### 1. ドキュメントとコードの整合性確認

#### docs/claude.mdとの照合
- エラーハンドリングの実装が推奨パターンに従っているか確認
- Claude SDK認証方式の説明と実装が一致しているか
- モック使用に関する記述と実装が一致しているか

#### 修正が必要な箇所
- ドキュメントに記載されているがコードに反映されていない部分
- コードに実装されているがドキュメントに記載されていない部分

### 2. テストカバレッジの確認

#### カバレッジレポートの生成と確認
```bash
pnpm test:coverage tests/claude/
```

#### 目標カバレッジ
- statements: 90%以上
- branches: 85%以上
- functions: 90%以上
- lines: 90%以上

#### カバレッジが低い箇所への対応
- 未テストの関数やブランチを特定
- 必要に応じてテストケースを追加（別タスクとして提案）

### 3. エラーハンドリングの最終確認

#### 各エンドポイントのエラーハンドリング
- try-catchブロックが適切に実装されているか
- エラーメッセージが開発者にとって有用な情報を含んでいるか
- エラーの再スローが適切に行われているか

#### エラーログの品質
- エンドポイント名、パラメータ、タイムスタンプが含まれているか
- エラーメッセージが具体的で分かりやすいか

### 4. コードクリーンアップ

#### 削除・修正が必要な項目
- 不要なコメント（特に「モック設定を削除」等の古いコメント）
- デバッグ用のconsole.log（本番で不要なもの）
- 未使用のインポート
- 重複したコード

#### コード品質の確認
- TypeScript strictモードでのエラーがないか
- lintエラーがないか
- 命名規則が統一されているか

### 5. テスト実行環境の最適化

#### beforeAll/afterAllフックの確認
- 環境変数の設定が適切か
- クリーンアップ処理が適切に実装されているか
- vi.clearAllMocks()の使用が適切か

#### テストの独立性
- 各テストが他のテストに依存していないか
- グローバル状態を変更するテストが適切にリセットされているか

### 6. CONTENT_TYPES定数の確認

テスト実行時に以下のような差異が見られた：
- 期待値: `['educational', 'market_analysis', 'trending', 'general']`
- 実際値: `['educational', 'market_analysis', 'trending', 'announcement', 'reply']`

この差異を確認し、必要に応じて修正する。

## ✅ 完了条件
- [ ] ドキュメントとコードが完全に一致している
- [ ] テストカバレッジが目標値を達成している
- [ ] 全てのエラーハンドリングが適切に実装されている
- [ ] 不要なコメントやデバッグコードが削除されている
- [ ] `pnpm test tests/claude/`が警告なしで正常に動作する
- [ ] `pnpm typecheck`と`pnpm lint`でエラーが発生しない

## 📝 注意事項
- 機能を損なわないよう慎重に作業する
- 削除する前に本当に不要かを確認する
- テストの安定性を維持する

## 🚀 実行コマンド
```bash
# テストカバレッジ確認
pnpm test:coverage tests/claude/

# 全テスト実行
pnpm test tests/claude/

# 型チェック
pnpm typecheck

# lint実行
pnpm lint
```

## 💡 実装のヒント
- git diffを使って変更内容を確認しながら作業
- 小さな変更ごとにテストを実行して動作確認
- ドキュメントの更新が必要な場合は別途報告