# TradingAssistantX システム概要

## ⚠️ 最重要原則：ディレクトリ・ファイル構造の絶対厳守

**ハルシネーション防止の根幹は、定義された構造の厳格な遵守にある。**

### 構造厳守の3原則
1. **要件定義に記載されたディレクトリ・ファイルのみ使用可能**
2. **新規ファイル・ディレクトリの作成は原則禁止**
3. **定期実行による構造の逸脱は integrity-checker.ts が自動検出・拒否**

この原則を破ることは、システム全体の信頼性を損なう最も重大な違反行為である。

## 1. ビジョンと理想像

### 🎯 ビジョン

**Claude Code SDK中心の完全自律システム**
- 🎯 自律的テーマ決定: Claudeが市場分析して最適テーマを決定
- 📈 自律的データ収集: 必要データを自動収集・分析
- ✍️自律的投稿作成: Claude Code SDKが全意思決定を担当し最適投稿を生成
- 🔄 継続的最適化: 実行結果から学習し品質向上

**革新的中心技術**: Claude Code SDKによる意思決定の完全委託

### 目標
X（Twitter）での価値創造による成長。投資初心者にも理解しやすい、質の高い教育コンテンツを提供し、フォロワーの投資リテラシー向上へ貢献する。

### 💡 システムの理想像

#### 自律的成長エンジン
- アカウントの現状を常に把握し、次の成長に必要な要素を自己分析
- フォロワーの反応やトレンドを学習し、最適な投稿戦略を自動更新
- 失敗からも学び、次回の投稿品質を継続的に改善

#### 自律ループシステム
- **1 日 15 回の定時実行**: 最適投稿時間（朝 7-8 時、昼 12 時、夕方 18-19 時、夜 21-23 時）に自律実行
- **data/ディレクトリ中心**: 各ループが前回学習を活用し、継続的成長を実現
- **コンテキスト最適化**: Claude Code SDK 向けに必要最小限の高品質データのみ保持
- **階層型データ管理（3層構造）**:
  - ホットデータ（current/）: 直近7日分、最大1MB、即座の意思決定用
  - ウォームデータ（learning/）: 90日分の分析済みインサイト、最大10MB
  - コールドデータ（archives/）: 全投稿の永続保存、容量無制限
  - 自動階層移動: 古いデータは自動的に下位層へ移動し、分析結果のみ保持

#### インテリジェントな意思決定
- **AI 駆動の全自動プロセス**: 人間の指示を待たず自律的に判断・実行
- **適応的戦略切替**: 状況に応じて柔軟に戦略を変更
- **機会発見**: 人間では気づかない成長機会を自動発見

### 実行原則
- **Claude主導**: 現在状況を分析し、最適なアクションを自律判断
- **品質重視**: 制限なく高品質な実装
- **データ駆動**: `data/`配下YAML設定による制御

## 2. システムアーキテクチャ

### 🏗️ アーキテクチャビジョン

#### 完全疎結合設計
```
データソース層: 無限に拡張可能な情報源
     ↓
知能層: 文脈理解と価値判断
     ↓
創造層: 独自の視点での価値創造
     ↓
成長層: 継続的な学習と最適化
```

### システム構成
- **Core**: 自律実行エンジン (`src/core/`)
  - `autonomous-executor.ts`: 自律実行エンジン
  - `decision-engine.ts`: 意思決定エンジン
  - `loop-manager.ts`: ループ実行管理
- **Collectors**: データ収集 (`src/collectors/`)
  - `rss-collector.ts`: RSS収集（MVP）
  - `playwright-account.ts`: アカウント分析専用
  - `base-collector.ts`: 基底クラス（疎結合設計）
- **Services**: ビジネスロジック (`src/services/`)
  - `content-creator.ts`: 投稿コンテンツ生成
  - `data-hierarchy-manager.ts`: 階層データ管理
  - `performance-analyzer.ts`: 分析・評価
  - `x-poster.ts`: X API投稿
- **Utils**: ユーティリティ (`src/utils/`)
  - `yaml-manager.ts`: YAML高度操作
  - `yaml-utils.ts`: YAML基本操作
  - `context-compressor.ts`: コンテキスト圧縮
  - `error-handler.ts`: エラーハンドリング
  - `file-size-monitor.ts`: ファイルサイズ監視
  - `monitoring/health-check.ts`: システムヘルスチェック
- **Scripts**: 実行スクリプト (`src/scripts/`)
  - `main.ts`: ループ実行 (pnpm start)
  - `dev.ts`: 単一実行 (pnpm dev)
  - `core-runner.ts`: 共通実行ロジック
- **Data**: YAML設定管理 (`data/`)

### 疎結合設計の特徴
- **データソース独立性**: 各Collectorは完全に独立して動作、相互依存なし
- **統一インターフェース**: CollectionResult型による抽象化で、新規データソース追加が容易
- **戦略的切り替え**: YAML ファイルの設定変更だけで、データソースの有効/無効を制御
- **拡張性重視**: 新しい Collector を追加しても既存コードへの影響を最小化

### MVP構成
- **Phase 1 (MVP)**: RSS Collector のみで投資教育コンテンツを収集・生成
- **将来拡張**: API、Community、Web スクレイピングなど多様なデータソースを段階的に追加

## 3. ブランディング戦略

### 🎨 成長段階別ブランディング

#### 初期段階（0-1000 フォロワー）
- 単一専門テーマに集中
- 推奨：「投資初心者向け基礎教育」特化
- 投稿の 80%を同一テーマカテゴリに統一
- 一貫したトーン：親しみやすく、分かりやすい解説

#### 成長段階（1000-5000 フォロワー）
- 関連テーマに段階的拡張
- 核となるテーマ（60%）+ 関連テーマ（40%）
- 専門性を保ちながら幅を広げる

#### 確立段階（5000+フォロワー）
- 多様なテーマ対応
- 現在の意思決定フローを適用

## 4. Claude Code SDK 意思決定カタログ

### 🧠 自律的意思決定の構造
Claude Code SDK が精度の高い自律的判断を行うため、利用可能な選択肢を体系化。各実行ループで最適なアクションを選択できる構造化された決定フレームワーク。

### 📋 利用可能なアクション・カタログ

#### 1. データ収集戦略
- **RSS 集中収集** (`collectors/rss-collector.ts`)
  - 適用条件: 安定した情報収集が必要、API 制限回避
  - 効果: 構造化された高品質データ、継続的更新
  - 動的クエリ: Google News検索と連携、テーマに応じた柔軟な情報収集
- **アカウント分析** (`collectors/playwright-account.ts`)
  - 適用条件: 自己状況把握、戦略調整時
  - 効果: フォロワー数・エンゲージメント率の正確な把握
- **複合データ収集** (将来拡張)
  - 適用条件: 多角的な情報が必要な重要トピック
  - 効果: より深い洞察、独自性の高いコンテンツ

#### 2. コンテンツ生成戦略
- **教育重視型** (`services/content-creator.ts`)
  - 適用条件: フォロワーが初心者中心、学習ニーズ高
  - 効果: 信頼性向上、長期的フォロワー獲得
- **トレンド対応型**
  - 適用条件: 話題性の高いニュース、瞬間的注目度重視
  - 効果: 短期的エンゲージメント向上、新規フォロワー獲得
- **分析特化型**
  - 適用条件: 市場動向が複雑、専門的解説が求められる
  - 効果: 権威性向上、専門性の認知

#### 3. 投稿タイミング戦略
- **定時投稿** (`data/config/posting-times.yaml`)
  - 適用条件: 安定したフォロワー習慣形成
  - 効果: 継続的エンゲージメント、習慣化促進
- **機会的投稿**
  - 適用条件: 重要ニュース発生、市場急変時
  - 効果: リアルタイム価値提供、注目度最大化
- **最適化投稿**
  - 適用条件: エンゲージメントデータ分析後
  - 効果: 時間帯別最適化、ROI 最大化

### 🇦 自律実行フロー

```
[1] 現在状況分析 (account-status.yaml・active-strategy.yaml読み込み)
[2] アカウント成長段階判定 + 戦略選択
[3] データ収集実行 (選択されたCollector起動)
[4] コンテンツ生成 (選択された戦略でcontent-creator実行)
[5] 品質確認・投稿実行 (x-poster.ts)
[6] 結果記録・学習データ更新 (data/learning/)
```

### 🎯 段階別意思決定フロー

```
自律実行開始
     ↓
[1] 現在状況分析 (account-status.yaml読み込み)
     ↓
[2] ブランド一貫性チェック + 戦略選択
     ├── フォロワー数 < 1000 →
     │    └── ブランドテーマ固定（投資基礎教育のみ）+ 定時投稿
     ├── フォロワー数 1000-5000 →
     │    ├── 核テーマ（60%確率）→ 投資基礎教育
     │    └── 関連テーマ（40%確率）→ 市場分析・銘柄解説
     ├── フォロワー数 > 5000 → 既存の動的戦略適用
     └── 緊急時（重要ニュース）→ 分析特化型（全段階共通）
     ↓
[3] データ収集実行 (選択されたCollector起動)
     ↓
[4] コンテンツ生成 (選択された戦略でcontent-creator実行)
     ↓
[5] 品質確認・投稿実行 (x-poster.ts)
     ↓
[6] 結果記録・学習データ更新 (data/learning/)
```

### 🔀 判断基準とマッピング

#### アカウント状態による分岐
- **成長初期段階**: RSS 集中 + 教育重視 + 定時投稿
- **成長軌道段階**: 複合収集 + バランス型 + 最適化投稿
- **確立段階**: 戦略的収集 + 分析特化 + 機会的投稿

#### エンゲージメントによる分岐
- **低エンゲージメント**: トレンド対応強化、投稿時間再調整
- **高エンゲージメント**: 現在戦略維持、質的向上集中
- **変動大**: A/B テスト的戦略切り替え

#### 外部環境による分岐
- **重要経済指標発表**: 即座に分析特化型へ切り替え
- **市場急変**: トレンド対応型 + 機会的投稿
- **通常時**: データ駆動の最適戦略継続

### 🔀 3次元判断マトリクス

**優先順位**: 外部環境 > エンゲージメント状態 > 成長段階

```
[外部環境] 緊急対応 → 分析特化型 + 機会的投稿
[通常環境] → [エンゲージメント判断]
  ├── 低エンゲージメント → 集中特化段階強制 + トレンド対応強化
  ├── 安定エンゲージメント → 成長段階適用
  │   ├── 集中特化段階 → RSS集中 + 教育重視 + 定時投稿
  │   ├── 段階的拡張段階 → 複合収集 + バランス型 + 最適化投稿
  │   └── 多様化展開段階 → 戦略的収集 + 分析特化 + 機会的投稿
  └── 高エンゲージメント → 現在戦略維持 + 質的向上集中
```

### 📊 アカウント成長段階別戦略

1. **集中特化段階**: 投資基礎教育特化（エンゲージメント低・テーマ分散時）
2. **段階的拡張段階**: 核テーマ60% + 関連テーマ40%（安定エンゲージメント時）
3. **多様化展開段階**: 動的戦略適用（高エンゲージメント・複数実績時）

### 🏗️ src ディレクトリとの対応
```
決定エンジン (core/decision-engine.ts)
     ↓ 戦略選択
各種コンポーネント実行:
├── collectors/ → データ収集選択肢実行
├── services/ → コンテンツ生成・投稿実行
├── utils/ → 支援機能（圧縮、YAML管理、整合性検証）
└── data/ → 判断材料・結果記録
```

## 5. 主要コンポーネント

### 🔧 Core Components
- **AutonomousExecutor**: 自律実行制御
  - 全体的な実行フローの管理
  - 各コンポーネントの協調動作制御
  - エラーハンドリングとリトライ機構

- **ActionSpecificCollector**: 情報収集
  - 動的データ収集戦略の実装
  - 複数のデータソースからの統合収集
  - 収集データの品質評価と選別

- **DecisionEngine**: 判断エンジン
  - 状況分析と最適戦略の決定
  - ブランド一貫性の維持
  - 成長段階に応じた戦略切り替え

### ワークフロー最適化

#### 🎯 トピック特化プロセス
- **フェーズ1**: 市場スキャン→トピック選定
- **フェーズ2**: 特化キーワード→情報収集
- **フェーズ3**: 品質評価→実行判断

#### 🚀 システム改善履歴
- **実行時間**: 240秒→900秒（15分）
- **情報源**: 制限解除→無制限
- **処理方式**: 最適化された実装
- **精度目標**: 充足度90%達成

### 開発・実行環境
- TypeScript strict mode必須
- YAML駆動による設定管理
- 疎結合設計による高い拡張性

### 📋 コマンドリファレンス
```bash
pnpm dev        # 単発実行
pnpm test       # テスト実行
pnpm lint       # 品質チェック
```

## 6. ハルシネーション防止機構

### 実行整合性チェックシステム
定期実行による反復でハルシネーションを起こさず、要件定義との整合性を常に保証する仕組み。**最重要原則（構造厳守）の自動実行を技術的に保証する。**

### 許可された出力先（厳格制限）
```yaml
# 書き込み許可ディレクトリ
allowed_write_paths:
  - data/current/ # 現在状態のみ
  - data/learning/ # 学習データ
  - data/archives/ # アーカイブ
  - tasks/outputs/ # 実行結果出力

# 書き込み禁止（読み取り専用）
readonly_paths:
  - src/ # ソースコード
  - data/config/ # 設定ファイル
  - tests/ # テストコード
  - docs/ # ドキュメント
  - REQUIREMENTS.md # 要件定義書
```

### 実行前後の検証フロー
1. **構造検証**: 要件定義のディレクトリ構造と完全一致確認
2. **ファイル数制限**: data/current/は最大 10 ファイルまで
3. **階層別サイズ制限**: 
   - current/: 最大1MB（ホットデータ）
   - learning/: 最大10MB（ウォームデータ）
   - archives/: 無制限（コールドデータ）
4. **命名規則**: 要件定義に記載されたファイル名のみ使用可

## 7. 理想のワークフロー

1. **自己認識**: Playwright で自アカウントを分析し、「今何が必要か」を自律的に判断
2. **戦略立案**: 階層型データから最適な戦略を高速選択（current→learning→archives）
3. **情報統合**: 実行時点の最新データと蓄積された知識を融合
4. **価値創造**: 単なる情報伝達を超えた、教育的価値の高いコンテンツ生成
5. **投稿＆アーカイブ**: X投稿と同時に生データをarchives/posts/へ自動保存
6. **効果測定＆分析**: 日次でインサイトを抽出しlearning層へ保存
7. **階層型データ管理**: 自動的にデータを移行（current→learning→archives）

## 8. 目指す成果

### 定量的目標
- フォロワー数の持続的成長
- エンゲージメント率の向上
- 投稿の教育的価値の最大化

### 定性的目標
- 投資初心者にも理解しやすい、質の高い教育コンテンツ
- 定期的な投稿による信頼感の構築と学習習慣のサポート
- フォロワーの投資リテラシー向上への貢献

### 将来の拡張性

#### 進化し続けるシステム
- 新しい情報源の自動発見と統合
- 投稿フォーマットの自律的な実験と最適化
- マルチプラットフォーム展開への対応力

#### スケーラビリティ
- 複数アカウントの同時運用
- 異なる投資分野への展開
- グローバル市場への対応

---

**究極の目標**: 人間を超える洞察力と継続力を持つ、真に自律的な投資教育コンテンツクリエーターの実現