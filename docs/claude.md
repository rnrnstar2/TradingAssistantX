# Claude Code SDK 仕様書

## 🎯 システムの本質的価値

Claude Code SDKは、TradingAssistantXの**知的中枢**として機能し、**独自性のある高付加価値FX情報とエッジの効いたFX市場分析を提供**します。

### 核心機能
- **AI独自性保証**: 他アカウントとの差別化・独自見解の創出
- **専門的市場分析**: リアルタイムFX情報への深い洞察・予測
- **エッジの効いた選択**: 安全より価値を重視した情報選択
- **予測・検証循環**: 市場予測とその結果検証による継続的改善

### MVPでの達成価値
- **教育コンテンツ品質**: FX初心者〜中級者への確実な価値提供
- **エンゲージメント最適化**: AI判断によるいいね・RT・フォロワー増最大化  
- **運用自動化**: 手動判断を排除した24時間体制での品質保証
- **戦略進化**: 深夜分析による翌日戦略の自動最適化

## 🏗️ エンドポイント設計哲学

### 設計原則：明確な責任分離
**「1エンドポイント = 1つの明確な責任」**により、保守性・拡張性・テスト容易性を実現。

| エンドポイント | 知的責任 | 価値提供 |
|---|---|---|
| `generateContent` | 教育的コンテンツ創造 | 時間帯・対象者・高エンゲージメント参考ツイートに基づく最適化されたコンテンツ |
| `selectOptimalTweet` | 知的選択判断 | 膨大な候補から最高品質ツイートの選択 |
| `generateQuoteComment` | 価値追加コメント | 独自視点による教育的価値の付加 |
| `analyzeTargetQueryResults` | FX市場情報分析 | 最大100件のツイートからFX市場のトレンド・重要情報を抽出 |
| `analyzeReferenceUserTweets` | FX専門家分析 | 特定ユーザーの専門性・最新見解・信頼性を評価 |
| `analyzePerformance` | 戦略分析・改善 | 投稿エンゲージメント分析による改善提案生成 |

### 設計の競争優位性
- **責任分離**: 各機能が独立し、変更影響を局所化
- **型安全連携**: TypeScript型による確実なデータフロー
- **統一アーキテクチャ**: KaitoAPIと同様の構造で学習コスト削減
- **段階的拡張**: 新機能は新エンドポイント追加のみで実現

## 🌟 selectOptimalTweet：知的選択の核心

**最重要機能**: 複数のツイート候補からFX教育的価値・エンゲージメント・信頼性を総合評価し、最適なツイートを選択。

### AI判断基準の設計

**リツイート・引用ツイート**
- **独自性評価（50%）**: 他の一般的見解との差別化度
- **専門性深度（30%）**: FX業界の深い知識・洞察度
- **予測・警告価値（15%）**: 将来のリスク・機会に関する情報価値
- **関連性適合（5%）**: 指定トピックとの適合度（重要度低下）

**いいね（専門性重視）**
- **専門性評価（70%）**: FX分野での専門知識・権威性
- **独自性評価（20%）**: 一般的でない独自の視点・分析
- **関係構築可能性（10%）**: 従来重視から大幅縮小

**フォロー（業界ネットワーク構築）**
- **業界影響力（50%）**: FX業界での影響力・権威性
- **独自情報源（30%）**: 他では得られない情報の提供能力
- **専門性適合（15%）**: 高度なFX知識レベル
- **相互関係可能性（5%）**: 従来重視から大幅縮小

### 入力設計（最小必要項目）
```typescript
{
  candidates: TweetCandidate[],           // 最大20件の候補
  selectionType: 'like' | 'retweet' | 'quote_tweet' | 'follow',
  criteria: {
    topic: string,                        // FX教育トピック
    qualityThreshold: number,             // 品質閾値（0-10）
    engagementWeight: number,             // エンゲージメント重視度
    relevanceWeight: number               // 関連性重視度
  }
}
```

### Claude判断の最適化
- **トークン効率化**: ツイート本文200文字制限による判断精度向上
- **情報選別**: 判断に不要な情報を排除し、核心要素のみ送信
- **判断速度**: 平均3-5秒での高精度選択実現

## 🔄 ワークフロー統合：4ステップの知的実行

### 統合設計の価値
Claude SDKは独立したツールではなく、KaitoAPIとDataManagerと統合された**知的実行システム**として機能。

### アクション別実行フロー

**投稿アクション**
```
トピック設定（schedule.yaml）→ [target_query検索（オプション）]→ 教育コンテンツ生成（generateContent）→ 投稿実行
```
- target_queryが指定されている場合、高エンゲージメントツイートを検索して参考にする
- 参考ツイートはプロンプトに含まれ、より魅力的なコンテンツ生成に活用される

**リツイートアクション**  
```
検索クエリ取得（schedule.yaml）→ 候補収集（KaitoAPI）→ AI選択（selectOptimalTweet）→ RT実行
```

**引用リツイートアクション**
```
検索クエリ取得（schedule.yaml）→ 候補収集（KaitoAPI）→ AI選択（selectOptimalTweet）→ 価値追加（generateQuoteComment）→ 引用RT実行
```

**いいねアクション**
```
検索クエリ取得（schedule.yaml）→ 候補収集（KaitoAPI）→ 関係構築評価（selectOptimalTweet）→ いいね実行
```

**フォローアクション**
```
検索クエリ取得（schedule.yaml）→ ユーザー検索（KaitoAPI）→ 戦略的関係構築評価（selectOptimalTweet）→ フォロー実行
```

### ワークフロー統合の効果
- **情報品質向上**: 事前定義クエリ→AI判断→コンテンツ生成の一貫フロー
- **戦略一貫性**: 全アクションで統一されたFX教育価値基準
- **学習循環**: 日中実行→深夜分析→翌日戦略最適化の24時間サイクル

## 🌙 深夜分析システム：24時間学習サイクル

毎日23:55に実行される深夜分析機能により、1日の実行データを分析し、翌日戦略を自動生成します。

**詳細仕様**: [docs/deep-night-analysis.md](../deep-night-analysis.md)

### 📝 実装状況注記
- 深夜分析機能（analyzePerformance, analyzeMarketContext等）は仕様策定済みですが、実装は保留中です
- 詳細仕様は[deep-night-analysis.md](./deep-night-analysis.md)を参照してください


## 📊 プロンプト変数システム：コンテクスト最適化

### 変数体系の設計思想
各変数は独自性・専門性・エッジの効いた市場分析の最大化のために厳選された要素。

| 変数分類 | 核心変数 | 最適化効果 |
|---|---|---|
| **独自性戦略** | `uniquenessScore`, `differentiationFactors` | 他アカウントとの差別化最大化 |
| **専門性戦略** | `industryInsights`, `expertiseLevel` | FX業界の深い知識活用 |
| **予測戦略** | `marketPredictions`, `riskWarnings` | データ分析による予測・警告 |
| **逆張り戦略** | `contrarianViews`, `antiConsensus` | 一般論への疑問提起・反常識視点 |
| **時間戦略** | `dayOfWeek`, `timeContext`, `hour` | 専門的市場分析タイミング最適化 |
| **アカウント戦略** | `followerCount`, `engagementRate`, `postsToday` | 専門性重視のフォロワー分析 |
| **学習戦略** | `recentTopics`, `avgEngagement`, `successPatterns` | 独自性重視のパターン学習 |
| **市場戦略** | `sentiment`, `volatility`, `trendingTopics` | リアルタイム市場連動コンテンツ |
| **参考戦略** | `referenceTweets` | 高エンゲージメントツイートを参考にした魅力的なコンテンツ生成 |

### 時間戦略の設計
- **朝（7-10時）**: 前日の海外FX市場分析・独自のFX市場予測
- **昼（12-14時）**: リアルタイムFX市場分析・FX業界内幕情報
- **夜（20-22時）**: 1日のFX市場総括・明日への独自見解・予測検証
- **週末**: 深いFX市場分析・独自フレームワーク・FX業界動向予測

## 🎨 プロンプトテンプレート管理：DRY原則による効率化

### 設計哲学
プロンプトの重複を完全排除し、一貫性のある高品質コンテンツ生成を実現。

### アーキテクチャ構造
```
src/claude/prompts/
├── templates/     # FX教育特化テンプレート
├── builders/      # コンテクスト統合ビルダー
└── index.ts       # 統一エクスポート
```

### BaseBuilderの価値
- **共通ロジック統合**: 時間帯判定・アカウント分析・市場状況処理を一元化
- **品質一貫性**: 全エンドポイントで統一されたFX教育価値基準
- **保守効率**: プロンプト変更が全システムに自動反映


## 🔐 認証・SDK設定：技術基盤

### Claude Code SDK設定
- **SDK**: `@instantlyeasy/claude-code-sdk-ts`（Claude Code Max Plan最大活用）
- **認証**: `claude login`ローカル認証（環境変数設定不要）
- **推奨モデル**: `sonnet`（教育コンテンツ生成に最適化）
- **必須設定**: `.skipPermissions()`使用

### エラーハンドリング戦略
```typescript
try {
  const response = await claude()
    .withModel('sonnet')
    .withTimeout(30000)
    .skipPermissions()
    .query(prompt)
    .asText();
} catch (error) {
  // 詳細ログ + 適切なエラー再スロー
}
```

### セッション永続化
- Twitterログインセッション自動保存（`data/current/twitter-session.yaml`）
- アプリ再起動後の認証スキップによる運用効率化

## 🧪 品質保証：テスト戦略

### エンドポイント別テスト設計
| エンドポイント | 品質検証項目 | 成功基準 |
|---|---|---|
| content-endpoint | 教育的価値・文体制御・文字数制限 | FX初心者理解度90%以上 |
| selection-endpoint | 選択精度・基準適用・リスク評価 | 選択品質スコア8.0以上 |
| analysis-endpoint | 投稿メトリクス分析・改善提案精度 | 戦略的価値85%以上 |
| data-analysis-endpoint | FX市場分析精度・インサイト品質 | 予測精度85%以上 |

### 品質保証体制
- **フレームワーク**: Jest + TypeScript厳格モード
- **カバレッジ要件**: 各エンドポイント90%以上
- **モッキング戦略**: Claude API完全モック化による高速テスト
- **統合テスト**: エンドポイント間連携の確実性検証

## 🎯 制約事項・設計ガイドライン

### 設計制限の理由
- **責任明確化**: 1エンドポイント=1責任により、変更影響の局所化
- **過剰設計回避**: MVPで実際に使用する機能のみ実装し、複雑性を排除
- **型安全優先**: コンパイル時エラー検出による実行時安定性確保
- **実用性重視**: FX教育コンテンツの価値最大化を最優先

### 成功への指針
- コード例より概念理解を重視
- 他ドキュメントとの重複完全回避
- FX教育価値の継続的向上
- システム全体の統合効果最大化

## 📈 期待される成果

### 投資情報価値の実現
- **独自性効果**: 他アカウントにはない差別化された情報提供
- **専門性効果**: 金融業界の深い洞察による信頼性向上
- **予測効果**: データ分析による的確な市場予測・リスク警告
- **エッジ効果**: 安全な情報より価値ある情報優先による成長促進

### システム価値の実現
- **差別化自動化**: 24時間体制での独自性のある情報提供
- **専門性進化**: 金融知識蓄積による継続的専門性向上
- **予測精度向上**: 予測・検証サイクルによる分析能力改善
- **エッジ最適化**: リスクを取った価値ある情報提供の実現


Claude Code SDKは、単なるAPI呼び出しツールではなく、独自性のある高付加価値FX情報とエッジの効いたFX市場分析の**知的品質保証システム**として、TradingAssistantXの核心価値を実現する統合プラットフォームです。