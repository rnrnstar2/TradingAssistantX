# ポジション・アクション実行フロー設計

## 1. ポジション実行（エントリー）

### 実行タイミング
- **手動実行**: 管理者画面の「実行」ボタンクリック
- **自動実行**: 価格条件達成時（currentPrice >= entryPrice）

### 実行フロー
1. ポジションステータス: PENDING → OPENING
2. 実行エンジンがエントリー処理
3. 成功時: OPENING → OPEN
4. 失敗時: OPENING → FAILED

### 管理者画面の役割
- ポジション作成
- 手動実行ボタンの提供
- ステータス表示

## 2. アクション実行（トレイル/決済）

### 実行タイミング
- **自動実行のみ**: トレイル条件達成時
- **手動実行なし**: 管理者画面からの実行不可

### 実行フロー
1. トレイル条件監視（実行エンジン）
2. 条件達成時、アクション自動作成
3. アクション実行（PENDING → EXECUTING → EXECUTED）
4. ポジション決済

### 管理者画面の役割
- アクション履歴の表示のみ
- 実行ボタンは配置しない

## 3. 重要な設計原則

- **ポジション**: 作成後、手動または自動でエントリー実行
- **アクション**: トレイルによる自動生成・自動実行のみ
- **管理者画面**: ポジション実行は可、アクション実行は不可

## 4. ステータス遷移

### ポジションステータス
```
PENDING → OPENING → OPEN → CLOSING → CLOSED
   ↓                   ↓        ↓
CANCELED           STOPPED   FAILED
```

### アクションステータス
```
PENDING → EXECUTING → EXECUTED
              ↓
           FAILED
```

## 5. 責務分担

### data-integration（UI層）
- ポジション作成フォーム
- ポジション一覧表示
- 手動実行ボタン（PENDINGポジションのみ）
- ステータス表示
- トレール設定表示（読み取り専用）

### execution-engine（実行層）
- 価格監視
- 自動エントリー実行
- トレイル条件監視
- アクション自動生成
- 決済処理

### realtime-system（リアルタイム層）
- 価格更新配信
- ポジションステータス更新通知
- アクションステータス更新通知

## 6. セキュリティ考慮事項

- ポジション実行は権限チェックが必要
- アクションの手動作成・実行は禁止
- 実行ログの適切な記録

## 7. エラーハンドリング

### ポジション実行失敗時
- ステータスをFAILEDに更新
- エラー理由を記録
- 管理者に通知

### アクション実行失敗時
- ステータスをFAILEDに更新
- リトライなし（MVP方針）
- ログに記録

## 8. 今後の拡張ポイント（MVP外）

- 複数ポジションの一括実行
- 条件付きエントリーの詳細設定
- トレイル戦略の高度化
- 実行履歴の詳細分析