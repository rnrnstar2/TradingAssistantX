# 深夜分析システム仕様書

> **📝 実装状況**: 深夜分析機能の完全な仕様書です。現在実装は保留中ですが、本仕様書に基づいて開発を行います。

## 🌙 概要

深夜分析（Deep Night Analysis）は、TradingAssistantXの投稿エンゲージメントを最適化する学習機能です。毎日23:55に実行され、最新50件の投稿のエンゲージメントを分析し、投稿戦略の参考データを生成・保存します。

### 目的（MVP版）
- **投稿エンゲージメント分析**: 最新50件の投稿の最新メトリクスを取得・更新
- **高パフォーマンスパターン特定**: エンゲージメントが高い投稿の共通点を分析
- **投稿最適化**: 戦略参考データとして最適な投稿時間・形式・トピックを分析・保存
- **継続的改善**: 毎日のエンゲージメントデータから学習し投稿品質を向上

### システム位置づけ
23:55のスケジュール実行時に`analyze`アクションが実行される独立したアクションです。詳細な実行フローは [workflow.md](workflow.md#analyzeアクション詳細) を参照してください。

## 📅 実行スケジュール

| 項目 | 詳細 |
|---|---|
| **実行時刻** | 毎日23:55（固定） |
| **実行頻度** | 1日1回 |
| **処理時間** | 約15-30分 |
| **完了予定** | 翌日00:30頃 |
| **データ活用** | 通常ワークフローでプロンプト変数として参照可能 |

## 🔄 分析プロセス

### Step 1: データ収集（投稿エンゲージメント特化）

**データ収集項目**: 自分の最新50件の投稿メトリクス

**KaitoAPI活用**:
- エンドポイント: `/twitter/tweets` 
- 取得メトリクス: いいね、RT、リプライ、インプレッション数、投稿日時
- 認証レベル: APIキーのみ（読み取り専用）
- 制限: 最大100件まで一括取得可能

APIエンドポイント詳細は [kaito-api.md](kaito-api.md#ツイートID一括取得) を参照してください。

**実装のポイント**: 最新50件の投稿IDを取得後、KaitoAPIで一括メトリクス取得

### Step 2: データ構造化

最新50件の投稿データを以下の要素に構造化してClaude分析に送信：

**基本データ**:
- 基本メトリクス（いいね数、RT数、リプライ数、インプレッション数）
- エンゲージメント率計算（エンゲージメント総数÷インプレッション数×100）
- 時間帯別集計（朝・昼・夜の平均エンゲージメント率）
- 形式別分析（番号付きリスト、質問形式、標準形式での成果比較）

**パフォーマンス評価**:
- 高（3.0%以上）・中（1.5-3.0%）・低（1.5%未満）の3段階評価
- 投稿からの経過日数によるエンゲージメント変化分析
- 最高パフォーマンス投稿の共通要素識別


### Step 3: Claude分析実行

**分析内容**:
- パフォーマンス評価（時間帯別・形式別・トピック別）
- 高エンゲージメント投稿の共通要素特定
- 戦略参考データ生成（推奨時間・形式・トピック）
- 低パフォーマンス要因の分析

**Claude応答内容**:
- 成功パターンの識別と改善提案
- 回避すべきパターンと理由
- 戦略的推奨事項（時間帯・形式・トピックの最適組み合わせ）
- 市場機会の分析（注目トピック、トレンド分析）

## 📁 出力ファイル

### 1. 日次戦略分析（data/current/strategy-analysis.yaml）

毎日上書き更新される分析結果。通常ワークフロー実行時にプロンプト変数として読み込まれます。

**主要項目**:
- 時間帯別成功率とオプティマルトピック
- 市場機会（関連度・推奨アクション・期待エンゲージメント）
- 最適化インサイト（パターン・実装方法・期待効果）
- 翌日の優先アクション（時間帯・アクション・戦略・推定効果）
- 回避ルール（条件・対応・理由）
- 投稿最適化（推奨トピック・回避トピック）


### 2. 学習データ累積更新（data/learning/）

**engagement-patterns.yaml**: 
- 過去30日分の時間帯別パフォーマンス
- 最適フォーマットとトピック
- エンゲージメントトレンド

**successful-topics.yaml**:
- トピック別パフォーマンス（エンゲージメント率・投稿数・トレンド）
- 最適時間帯情報
- 回避すべきトピック


## 🔧 実装統合

### ワークフロー統合

analyzeアクション判定時の処理フロー：
1. 深夜分析開始
2. `executeDeepNightAnalysis()`で専用ワークフロー実行
3. 50件の投稿メトリクス取得・更新
4. 投稿エンゲージメント統合分析実行
5. strategy-analysis.yamlに結果保存

### 実行メソッド構成

**専用メソッド**:
- `executeDeepNightAnalysis()`: analyzeアクション専用ワークフロー
- `updatePostEngagementMetrics()`: 50件投稿メトリクス取得・更新
- `analyzePostEngagement()`: 統合分析実行
- `saveAnalysisResults()`: 結果保存

### 投稿メトリクス更新実装のポイント

最新50件の投稿を取得し、KaitoAPIで一括メトリクス取得後、エンゲージメント率を計算して構造化データとして保存します。取得したデータはClaude分析用にパフォーマンス分析項目（時間帯別傾向、形式別成果、鮮度とパフォーマンス相関）として整理されます。

## ⚠️ エラーハンドリング

### 基本原則
分析エラーが発生してもワークフロー全体は継続動作します。

### タイムアウト設定
- 通常のClaude API呼び出し: 15秒
- 深夜分析のClaude API呼び出し: 60秒（長時間処理対応）

### フォールバック戦略
分析失敗時はデフォルト戦略（朝の投資教育コンテンツ）で翌日ワークフローが実行可能です。

## 💡 分析結果の活用

### プロンプト変数としての活用

通常ワークフロー実行時、Claude SDKのプロンプト生成で分析結果を参考データとして活用：


**活用効果**:
- 高パフォーマンストピックの優先選択（コンテンツ最適化）
- 成功率の高い時間帯での投稿強化（時間帯最適化）
- 低パフォーマンストピックの回避（リスク回避）


### 期待される成果

**短期的効果（1週間以内）**:
- 時間帯別成功率の可視化と最適化
- 高成功率パターンの再現性向上
- 不適切なタイミングでのアクション防止

**中期的効果（1ヶ月以内）**:
- データドリブンな戦略による着実な成長
- 反応の良いトピックへの集中
- 自動最適化による手動調整の削減

**長期的効果（3ヶ月以降）**:
- 一貫した高品質コンテンツによる信頼構築
- エンゲージメント最適化による活発な交流
- 学習データ蓄積による精度の累積的向上


## 🔍 監視とデバッグ

### ログ出力例

深夜分析の進行状況とパフォーマンス情報を詳細にログ出力します。

### 生成ファイル確認コマンド

- 分析結果確認: `cat data/current/strategy-analysis.yaml`
- 学習データ確認: `ls -la data/learning/`
- 実行ログ確認: `cat data/current/execution-*-2355/post.yaml`

### デバッグのポイント

- KaitoAPI接続エラー時の確認手順
- Claude分析タイムアウト時の対処
- YAML形式妥当性の検証方法
- エンゲージメント率計算時のゼロ除算回避

## 🚀 MVP実装計画

### Phase 1: MVP（1週間以内） - 投稿エンゲージメント分析
- 投稿エンゲージメント更新メカニズム
- 投稿パフォーマンスの時系列集計
- 高パフォーマンス投稿パターンの特定

### Phase 2: 拡張機能（1ヶ月以内）
- 他のアクション（RT、いいね等）のパフォーマンス分析
- より詳細な時間軸分析
- A/Bテスト機能

### Phase 3: 高度な分析（3ヶ月以降）
- 機械学習による予測モデル
- リアルタイム市場連動
- マルチモーダルコンテンツ戦略

## 📝 MVP実装チェックリスト

### 必須実装項目（MVP簡略版）

#### データ収集機能
- [ ] 最新50件の投稿ID取得機能（自分の投稿のみ）
- [ ] KaitoAPI `/twitter/tweets` エンドポイント統合
- [ ] 投稿メトリクス一括取得（いいね、RT、リプライ、インプレッション）
- [ ] エンゲージメント率計算ロジック（エンゲージメント総数÷インプレッション数×100）

#### データ構造化・分析
- [ ] 構造化データ変換（基本メトリクス、時間帯別集計、形式別分析）
- [ ] パフォーマンス評価（高・中・低の3段階分類）
- [ ] 投稿エンゲージメント統合分析（Claude分析）
- [ ] 分析結果の信頼度スコア算出

#### ファイル出力・保存
- [ ] strategy-analysis.yaml保存処理（日次戦略分析）
- [ ] engagement-patterns.yaml累積更新（時間帯・形式パターン）
- [ ] successful-topics.yaml累積更新（トピック別パフォーマンス）
- [ ] 分析実行ログの保存（execution-YYYYMMDD-2355/）

#### エラーハンドリング・品質保証
- [ ] KaitoAPI接続エラー時のフォールバック処理
- [ ] Claude分析タイムアウト処理（60秒）
- [ ] YAML形式妥当性検証
- [ ] 欠損値・異常値の適切な処理

### 削除項目（MVP対象外）
- ❌ 1日分の実行データ集計
- ❌ market分析（市場トレンド分析）
- ❌ 複数分析タイプの分岐処理
- ❌ 複雑な学習データ統合
- ❌ リアルタイム分析機能
- ❌ A/Bテスト機能

### 実装完了基準
- [ ] 23:55スケジュール実行での自動深夜分析動作確認
- [ ] 50件の投稿データ正常取得・分析完了
- [ ] strategy-analysis.yamlの正常生成・プロンプト変数活用確認
- [ ] エラー発生時のワークフロー継続動作確認

実装ファイル構造は [directory-structure.md](directory-structure.md) を参照してください。