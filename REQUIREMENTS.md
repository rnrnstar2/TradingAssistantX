# TradingAssistantX 要件定義書

## 🎯 ビジョン

**Claude Code SDK中心の完全自律システム**
- 🎯 自律的テーマ決定: Claudeが市場分析して最適テーマを決定
- 📊 自律的データ収集: 必要データを自動収集・分析
- ✍️自律的投稿作成: Claude Code SDKが全意思決定を担当し最適投稿を生成
- 🔄 継続的最適化: 実行結果から学習し品質向上

**革新的中心技術**: Claude Code SDKによる意思決定の完全委託

## 💡 システムの理想像

### 自律的成長エンジン
- 1日15回の定時実行で最適投稿時間に自律実行
- アカウント現状把握と次の成長要素を自己分析
- フォロワー反応やトレンド学習による投稿戦略自動更新
- 失敗からの学習による継続的品質改善

### インテリジェントな意思決定
- AI駆動の全自動プロセス（人間の指示待ち不要）
- 状況に応じた適応的戦略切替
- 人間では気づかない成長機会の自動発見

## 🏗️ システムアーキテクチャ

### 完全疎結合設計
**データソース独立性と意思決定分岐の容易性確保**
- 🔗 **データソース疎結合**: 各収集源（RSS/API/Community）は完全独立動作
- 📊 **統一インターフェース**: CollectionResult型でデータ統合、ソース固有性保持
- ⚡ **動的戦略切替**: ActionSpecificCollectorによる動的データ収集戦略
- 🎛️ **設定駆動制御**: YAML設定によるソース選択・優先度制御

```
意思決定層 (core/): アカウント状況分析・戦略選択
     ↓ 戦略指示
データ収集層 (collectors/): RSS・API・Community (独立)
     ↓ 構造化データ  
コンテンツ創造層 (services/): 投稿生成・品質確保・投稿実行
     ↓ 実行結果
学習・最適化層 (data/): 結果分析・戦略更新・階層管理
```

### 階層型データ管理（3層構造）
- **ホットデータ** (current/): 直近7日分、最大1MB、即座の意思決定用
- **ウォームデータ** (learning/): 90日分の分析済みインサイト、最大10MB
- **コールドデータ** (archives/): 全投稿の永続保存、容量無制限
- **自動階層移動**: 古いデータは自動的に下位層へ移動し、分析結果のみ保持

## 🧠 Claude Code SDK意思決定カタログ

### 利用可能なアクション・カタログ

#### 1. データ収集戦略
- **RSS集中収集** (`collectors/rss-collector.ts`): 安定情報収集、API制限回避
- **アカウント分析** (`collectors/playwright-account.ts`): 自己状況把握、戦略調整
- **複合データ収集** (将来拡張): 多角的情報、独自性高コンテンツ

#### 2. コンテンツ生成戦略
- **教育重視型**: フォロワー初心者中心、信頼性向上
- **トレンド対応型**: 話題性重視、短期エンゲージメント向上
- **分析特化型**: 市場複雑時、権威性向上

#### 3. 投稿タイミング戦略
- **定時投稿**: 安定習慣形成、継続エンゲージメント
- **機会的投稿**: 重要ニュース時、注目度最大化
- **最適化投稿**: データ分析後、ROI最大化

### アカウント成長段階別戦略
1. **集中特化段階**: 投資基礎教育特化（エンゲージメント低・テーマ分散時）
2. **段階的拡張段階**: 核テーマ60% + 関連テーマ40%（安定エンゲージメント時）
3. **多様化展開段階**: 動的戦略適用（高エンゲージメント・複数実績時）

### 3次元判断マトリクス
**優先順位**: 外部環境 > エンゲージメント状態 > 成長段階

```
[外部環境] 緊急対応 → 分析特化型 + 機会的投稿
[通常環境] → [エンゲージメント判断]
  ├── 低エンゲージメント → 集中特化段階強制 + トレンド対応強化
  ├── 安定エンゲージメント → 成長段階適用
  │   ├── 集中特化段階 → RSS集中 + 教育重視 + 定時投稿
  │   ├── 段階的拡張段階 → 複合収集 + バランス型 + 最適化投稿
  │   └── 多様化展開段階 → 戦略的収集 + 分析特化 + 機会的投稿
  └── 高エンゲージメント → 現在戦略維持 + 質的向上集中
```

### 自律実行フロー
```
[1] 現在状況分析 (account-status.yaml・active-strategy.yaml読み込み)
[2] アカウント成長段階判定 + 戦略選択
[3] データ収集実行 (選択されたCollector起動)
[4] コンテンツ生成 (選択された戦略でcontent-creator実行)
[5] 品質確認・投稿実行 (x-poster.ts)
[6] 結果記録・学習データ更新 (data/learning/)
```

### 革新的特徴
- **完全疎結合設計**: RSSから始まり、将来的にはAPI、Communityなど動的追加可能
- **Claude Code SDK活用**: 人間のような思考プロセスで文脈理解し価値創造
- **自己進化システム**: 投稿結果を分析し、戦略を自動最適化

## 🚨 MVP構成とYAML駆動開発

### RSS Collector中心の段階的実装
- **Phase 1 (MVP)**: RSS Collectorのみで投資教育コンテンツを収集・生成
- **将来拡張**: API、Community、Webスクレイピングなど多様なデータソースを段階的に追加

### 疎結合設計の重要性
- **データソース独立性**: 各Collectorは完全に独立して動作、相互依存なし
- **統一インターフェース**: CollectionResult型による抽象化で、新規データソース追加が容易
- **戦略的切り替え**: YAMLファイルの設定変更だけで、データソースの有効/無効を制御
- **拡張性重視**: 新しいCollectorを追加しても既存コードへの影響を最小化

### RSS Collectorの特徴
- 主要金融メディアのRSSフィードから効率収集
- 構造化データで安定した情報品質確保
- **動的クエリ対応**: Google News検索と連携、テーマに応じた柔軟な情報収集
  - 固定URLとクエリベースの両方式をサポート
  - YAMLで「query」フィールドを指定すると自動的に検索URLを生成
  - Claude Code SDKが自律的に最適な検索条件を選択可能

### アカウント分析の特別扱い
- **Playwright使用**: 自アカウントの分析（フォロワー数、エンゲージメント率）のみPlaywrightを使用
- **分析と収集の分離**: アカウント分析（Playwright）と情報収集（RSS）は完全に独立
- **認証対応**: X APIの制限を回避し、確実に自アカウントデータを取得
- **最小限の利用**: ブラウザ自動化は自アカウント分析に限定し、一般的な情報収集にはRSSを使用

## 🚀 理想のワークフロー

1. **自己認識**: アカウント分析で「今何が必要か」を自律判断
2. **戦略立案**: 階層データから最適戦略を高速選択
3. **情報統合**: 最新データと蓄積知識を融合
4. **価値創造**: 教育的価値の高いコンテンツ生成
5. **投稿＆保存**: 投稿と同時にデータ保存・バックアップ
6. **効果測定**: 日次インサイト抽出
7. **階層管理**: 自動データ移行（current→learning→archives）

## 🎯 目指す成果

### 定量的目標
- フォロワー数の持続的成長
- エンゲージメント率の向上
- 投稿の教育的価値の最大化

### 定性的目標
- 投資初心者にも理解しやすい、質の高い教育コンテンツ
- 定期的な投稿による信頼感の構築と学習習慣のサポート
- フォロワーの投資リテラシー向上への貢献

## 🌟 将来の拡張性

### 進化し続けるシステム
- 新しい情報源の自動発見と統合
- 投稿フォーマットの自律的な実験と最適化
- マルチプラットフォーム展開への対応力

### スケーラビリティ
- 複数アカウントの同時運用
- 異なる投資分野への展開
- グローバル市場への対応

## 📁 ディレクトリ・ファイル構造

### ⚠️ 構造厳守の絶対原則
**ハルシネーション防止の根幹**: 定義された構造の厳格遵守
1. 記載されたディレクトリ・ファイルのみ使用可能
2. 新規ファイル・ディレクトリ作成は原則禁止
3. integrity-checker.tsが自動検出・拒否

### ルートディレクトリ
```
TradingAssistantX/
├── src/         # ソースコード
├── data/        # YAML設定・データ
├── tests/       # テストコード
├── docs/        # ドキュメント
└── REQUIREMENTS.md
```

### /src ディレクトリ
```
src/
├── core/        # コアシステム
│   ├── autonomous-executor.ts  # 自律実行エンジン
│   ├── decision-engine.ts     # 意思決定エンジン
│   └── loop-manager.ts        # ループ管理
├── collectors/  # データ収集
│   ├── rss-collector.ts       # RSS収集（MVP）
│   ├── playwright-account.ts  # アカウント分析専用
│   └── base-collector.ts      # 基底クラス
├── services/    # ビジネスロジック
│   ├── content-creator.ts        # 投稿生成
│   ├── data-hierarchy-manager.ts # 階層データ管理
│   ├── performance-analyzer.ts   # 分析・評価
│   └── x-poster.ts              # X投稿
├── utils/       # ユーティリティ（最適化済み）
│   ├── yaml-manager.ts         # YAML高度操作
│   ├── yaml-utils.ts           # YAML基本操作
│   ├── context-compressor.ts   # コンテキスト圧縮
│   ├── error-handler.ts        # エラーハンドリング
│   ├── file-size-monitor.ts    # ファイルサイズ監視
│   └── monitoring/
│       └── health-check.ts     # システムヘルスチェック
└── scripts/     # 実行スクリプト
    ├── main.ts      # ループ実行（pnpm start）
    ├── dev.ts       # 単一実行（pnpm dev）
    └── core-runner.ts # 共通実行ロジック
```

### /data ディレクトリ（変更厳禁）
```
data/
├── config/      # システム設定（読み取り専用）
│   ├── autonomous-config.yaml
│   ├── posting-times.yaml
│   ├── rss-sources.yaml
│   └── brand-strategy.yaml
├── current/     # ホットデータ（1MB・7日・20ファイル上限）
│   ├── account-status.yaml
│   ├── active-strategy.yaml
│   ├── today-posts.yaml
│   └── weekly-summary.yaml
├── learning/    # ウォームデータ（10MB・90日上限）
│   ├── post-insights.yaml
│   └── engagement-patterns.yaml
└── archives/    # コールドデータ（無制限・永続）
    ├── posts/YYYY-MM/
    └── insights/YYYY-Q/
```

## 🔒 ハルシネーション防止機構

### 許可された出力先（厳格制限）
```yaml
# 書き込み許可
allowed_paths:
  - data/current/
  - data/learning/
  - data/archives/
  - tasks/outputs/

# 書き込み禁止（読み取り専用）
readonly_paths:
  - src/
  - data/config/
  - tests/
  - docs/
```

### 実行前後の検証
1. 構造検証：要件定義と完全一致確認
2. ファイル数・サイズ制限チェック
3. 命名規則：記載されたファイル名のみ使用可
4. 実行ログ記録：異常時は即座にロールバック

### 禁止事項
- 要件定義にないファイル・ディレクトリ作成
- srcディレクトリ内変更（Manager以外）
- ルートディレクトリへの直接ファイル作成

---

**究極の目標**: 人間を超える洞察力と継続力を持つ、真に自律的な投資教育コンテンツクリエーターの実現
