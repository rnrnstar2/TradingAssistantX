"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.PlaywrightAccountCollector = void 0;
const playwright_common_config_1 = require("./playwright-common-config");
class PlaywrightAccountCollector {
    browser = null;
    context = null;
    config = {
        timeout: 30000,
        maxRetries: 3,
        requestDelay: 2000,
        testMode: process.env.X_TEST_MODE === 'true'
    };
    constructor() { }
    async collectAccountInfo(username) {
        console.log('üé≠ [PlaywrightÂèéÈõÜÈñãÂßã] „Ç¢„Ç´„Ç¶„É≥„ÉàÊÉÖÂ†±„ÇíÂèéÈõÜ‰∏≠...');
        try {
            await this.initializeBrowser();
            const targetUsername = username || await this.getCurrentUsername();
            const profileUrl = `https://x.com/${targetUsername}`;
            console.log(`üîç [„Éó„É≠„Éï„Ç£„Éº„É´„Ç¢„ÇØ„Çª„Çπ] ${profileUrl}`);
            const page = await this.context.newPage();
            await page.goto(profileUrl, {
                waitUntil: 'networkidle',
                timeout: this.config.timeout
            });
            // „Éö„Éº„Ç∏„ÅÆË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖÊ©ü
            await this.waitForPageLoad(page);
            // Âü∫Êú¨„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÇíÊäΩÂá∫
            const basicInfo = await this.extractBasicInfo(page, targetUsername);
            // „Éï„Ç©„É≠„ÉØ„ÉºÁµ±Ë®à„ÇíÊäΩÂá∫
            const stats = await this.extractFollowerStats(page);
            // ÊúÄËøë„ÅÆÊäïÁ®øÊÉÖÂ†±„ÇíÂèñÂæó
            const recentPostTime = await this.extractLastTweetTime(page);
            const accountInfo = {
                username: targetUsername,
                user_id: basicInfo.user_id || targetUsername,
                display_name: basicInfo.display_name,
                bio: basicInfo.bio,
                verified: basicInfo.verified,
                followers_count: stats.followers,
                following_count: stats.following,
                tweet_count: stats.tweets,
                listed_count: 0, // X.com„Åß„ÅØÈÄöÂ∏∏Ë°®Á§∫„Åï„Çå„Å™„ÅÑ
                last_updated: Date.now(),
                last_tweet_time: recentPostTime,
            };
            console.log(`üìä [Áµ±Ë®àÊäΩÂá∫] „Éï„Ç©„É≠„ÉØ„Éº: ${stats.followers.toLocaleString()}„ÄÅ„Éï„Ç©„É≠„Éº: ${stats.following.toLocaleString()}„ÄÅ„ÉÑ„Ç§„Éº„Éà: ${stats.tweets.toLocaleString()}`);
            console.log('‚úÖ [ÂèéÈõÜÂÆå‰∫Ü] „Ç¢„Ç´„Ç¶„É≥„ÉàÊÉÖÂ†±„ÇíÊ≠£Â∏∏„Å´ÂèñÂæó');
            await page.close();
            return accountInfo;
        }
        catch (error) {
            console.error('‚ùå [PlaywrightÂèéÈõÜ„Ç®„É©„Éº]:', error);
            throw error;
        }
        finally {
            await this.cleanup();
        }
    }
    async collectRecentPosts(username, limit = 10) {
        console.log(`üìù [ÊäïÁ®øÂèéÈõÜ] ÊúÄËøë„ÅÆÊäïÁ®ø${limit}‰ª∂„ÇíÂèéÈõÜ‰∏≠...`);
        try {
            await this.initializeBrowser();
            const targetUsername = username || await this.getCurrentUsername();
            const profileUrl = `https://x.com/${targetUsername}`;
            const page = await this.context.newPage();
            await page.goto(profileUrl, {
                waitUntil: 'networkidle',
                timeout: this.config.timeout
            });
            await this.waitForPageLoad(page);
            // „ÉÑ„Ç§„Éº„ÉàË¶ÅÁ¥†„ÇíÂæÖÊ©ü
            await page.waitForSelector('[data-testid="tweet"]', { timeout: this.config.timeout });
            // ÊäïÁ®øË¶ÅÁ¥†„ÇíÂèñÂæó
            const posts = await this.extractRecentPosts(page, limit);
            console.log(`üìù [ÊäïÁ®øÂèéÈõÜÂÆå‰∫Ü] ${posts.length}‰ª∂„ÅÆÊäïÁ®ø„ÇíÂèéÈõÜ`);
            await page.close();
            return posts;
        }
        catch (error) {
            console.error('‚ùå [ÊäïÁ®øÂèéÈõÜ„Ç®„É©„Éº]:', error);
            return [];
        }
        finally {
            await this.cleanup();
        }
    }
    async initializeBrowser() {
        if (this.browser && this.context)
            return;
        const environment = await playwright_common_config_1.PlaywrightCommonSetup.createPlaywrightEnvironment(this.config);
        this.browser = environment.browser;
        this.context = environment.context;
    }
    async waitForPageLoad(page) {
        const selectors = [
            '[data-testid="UserName"]',
            '[data-testid="UserDescription"]',
            '[role="main"]'
        ];
        await playwright_common_config_1.PlaywrightCommonSetup.waitForPageLoad(page, selectors, this.config.timeout);
    }
    async extractBasicInfo(page, username) {
        try {
            // Ë°®Á§∫Âêç„ÇíÂèñÂæóÔºàË§áÊï∞„ÅÆ„Çª„É¨„ÇØ„Çø„Éº„Éë„Çø„Éº„É≥„ÇíË©¶Ë°åÔºâ
            const displayName = await this.tryMultipleSelectors(page, [
                '[data-testid="UserName"] div[dir="ltr"] span',
                '[data-testid="UserName"] span[role="heading"]',
                'h1[role="heading"]',
                'h2[role="heading"]'
            ]) || username;
            // „Éó„É≠„Éï„Ç£„Éº„É´„Éê„Ç§„Ç™„ÇíÂèñÂæó
            const bio = await this.tryMultipleSelectors(page, [
                '[data-testid="UserDescription"]',
                '[data-testid="UserBio"]'
            ]) || '';
            // Ë™çË®º„Éê„ÉÉ„Ç∏„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const verifiedBadge = await page.$('[data-testid="verifiedBadge"]');
            const verified = verifiedBadge !== null;
            return {
                user_id: username,
                display_name: displayName,
                bio: bio,
                verified: verified
            };
        }
        catch (error) {
            console.warn('‚ö†Ô∏è [Âü∫Êú¨ÊÉÖÂ†±ÊäΩÂá∫„Ç®„É©„Éº]:', error);
            return {
                user_id: username,
                display_name: username,
                bio: '',
                verified: false
            };
        }
    }
    async extractFollowerStats(page) {
        try {
            // „Éï„Ç©„É≠„ÉØ„ÉºÊï∞„ÇíÂèñÂæóÔºàË§áÊï∞„ÅÆ„Çª„É¨„ÇØ„Çø„Éº„Éë„Çø„Éº„É≥„ÇíË©¶Ë°åÔºâ
            const followersText = await this.tryMultipleSelectors(page, [
                'a[href*="/followers"] span[data-testid="UserName"] span',
                'a[href*="/followers"] span:not([dir])',
                '[data-testid="primaryColumn"] a[href*="/followers"] span'
            ]);
            // „Éï„Ç©„É≠„ÉºÊï∞„ÇíÂèñÂæó
            const followingText = await this.tryMultipleSelectors(page, [
                'a[href*="/following"] span[data-testid="UserName"] span',
                'a[href*="/following"] span:not([dir])',
                '[data-testid="primaryColumn"] a[href*="/following"] span'
            ]);
            // „Çà„ÇäÊ±éÁî®ÁöÑ„Å™„Ç¢„Éó„É≠„Éº„ÉÅ„Åß„Éó„É≠„Éï„Ç£„Éº„É´Áµ±Ë®à„ÇíÂèñÂæó
            const statsElements = await page.$$('[role="link"] span');
            let followers = 0, following = 0, tweets = 0;
            for (const element of statsElements) {
                const text = await element.textContent();
                if (text) {
                    // Êï∞ÂÄ§„ÇíÂê´„ÇÄ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊé¢„Åô
                    const numberMatch = text.match(/[\d,]+/);
                    if (numberMatch) {
                        const number = this.parseNumber(numberMatch[0]);
                        // ÂâçÂæå„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Åß„Çø„Ç§„Éó„ÇíÂà§ÂÆö
                        const parent = await element.evaluateHandle(el => el.parentElement);
                        const parentText = await parent.evaluate(el => el.textContent?.toLowerCase() || '');
                        if (parentText.includes('followers') || parentText.includes('„Éï„Ç©„É≠„ÉØ„Éº')) {
                            followers = number;
                        }
                        else if (parentText.includes('following') || parentText.includes('„Éï„Ç©„É≠„Éº')) {
                            following = number;
                        }
                        else if (parentText.includes('posts') || parentText.includes('tweets') || parentText.includes('„ÉÑ„Ç§„Éº„Éà')) {
                            tweets = number;
                        }
                    }
                }
            }
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºö„ÉÜ„Ç≠„Çπ„Éà„Éô„Éº„Çπ„Åß„ÅÆÊäΩÂá∫
            if (followers === 0 && followersText) {
                followers = this.parseNumber(followersText);
            }
            if (following === 0 && followingText) {
                following = this.parseNumber(followingText);
            }
            return { followers, following, tweets };
        }
        catch (error) {
            console.warn('‚ö†Ô∏è [Áµ±Ë®àÊäΩÂá∫„Ç®„É©„Éº]:', error);
            return { followers: 0, following: 0, tweets: 0 };
        }
    }
    async extractLastTweetTime(page) {
        try {
            // ÊúÄÂàù„ÅÆ„ÉÑ„Ç§„Éº„Éà„ÅÆ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÇíÂèñÂæó
            const timeElements = await page.$$('[data-testid="tweet"] time');
            if (timeElements.length > 0) {
                const datetime = await timeElements[0].getAttribute('datetime');
                if (datetime) {
                    return new Date(datetime).getTime();
                }
            }
            return Date.now() - (24 * 60 * 60 * 1000); // 24ÊôÇÈñìÂâç„Çí„Éá„Éï„Ç©„É´„Éà
        }
        catch (error) {
            console.warn('‚ö†Ô∏è [ÊúÄÊñ∞ÊäïÁ®øÊôÇÈñìÂèñÂæó„Ç®„É©„Éº]:', error);
            return Date.now() - (24 * 60 * 60 * 1000);
        }
    }
    async extractRecentPosts(page, limit) {
        try {
            const posts = [];
            const tweetElements = await page.$$('[data-testid="tweet"]');
            for (let i = 0; i < Math.min(tweetElements.length, limit); i++) {
                const tweet = tweetElements[i];
                try {
                    // „ÉÑ„Ç§„Éº„ÉàÂÜÖÂÆπ„ÇíÂèñÂæó
                    const contentElement = await tweet.$('[data-testid="tweetText"]');
                    const content = contentElement ? await contentElement.textContent() : '';
                    // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÇíÂèñÂæó
                    const timeElement = await tweet.$('time');
                    const datetime = timeElement ? await timeElement.getAttribute('datetime') : null;
                    const timestamp = datetime ? new Date(datetime).getTime() : Date.now();
                    // „Ç®„É≥„Ç≤„Éº„Ç∏„É°„É≥„ÉàÊï∞„ÇíÂèñÂæóÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
                    const likes = await this.extractEngagementCount(tweet, 'like');
                    const retweets = await this.extractEngagementCount(tweet, 'retweet');
                    const replies = await this.extractEngagementCount(tweet, 'reply');
                    if (content && content.trim()) {
                        posts.push({
                            id: `tweet-${timestamp}-${i}`,
                            content: content.trim(),
                            timestamp,
                            likes,
                            retweets,
                            replies
                        });
                    }
                }
                catch (error) {
                    console.warn(`‚ö†Ô∏è [ÊäïÁ®ø${i}ÊäΩÂá∫„Ç®„É©„Éº]:`, error);
                }
            }
            return posts;
        }
        catch (error) {
            console.warn('‚ö†Ô∏è [ÊäïÁ®ø„É™„Çπ„ÉàÊäΩÂá∫„Ç®„É©„Éº]:', error);
            return [];
        }
    }
    async extractEngagementCount(tweetElement, type) {
        try {
            const testIds = {
                like: 'like',
                retweet: 'retweet',
                reply: 'reply'
            };
            const engagementElement = await tweetElement.$(`[data-testid="${testIds[type]}"] span`);
            if (engagementElement) {
                const text = await engagementElement.textContent();
                return text ? this.parseNumber(text) : 0;
            }
            return 0;
        }
        catch (error) {
            return 0;
        }
    }
    async tryMultipleSelectors(page, selectors) {
        return playwright_common_config_1.PlaywrightCommonSetup.tryMultipleSelectors(page, selectors);
    }
    parseNumber(text) {
        return playwright_common_config_1.PlaywrightCommonSetup.parseNumber(text);
    }
    async getCurrentUsername() {
        try {
            // 1. Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„Åã„ÇâÂèñÂæó„ÇíË©¶Ë°å
            const fs = (await Promise.resolve().then(() => __importStar(require('fs')))).default;
            const yaml = (await Promise.resolve().then(() => __importStar(require('js-yaml')))).default;
            const path = (await Promise.resolve().then(() => __importStar(require('path')))).default;
            const configPath = path.join(process.cwd(), 'data/account-config.yaml');
            if (fs.existsSync(configPath)) {
                const configData = yaml.load(fs.readFileSync(configPath, 'utf8'));
                const username = configData?.account?.username;
                if (username && username !== 'defaultuser') {
                    console.log(`üîß [„É¶„Éº„Ç∂„ÉºÂêçÂèñÂæó] Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„Åã„Çâ: ${username}`);
                    return username;
                }
            }
            // 2. Áí∞Â¢ÉÂ§âÊï∞„Åã„ÇâÂèñÂæó
            const envUsername = process.env.X_USERNAME;
            if (envUsername && envUsername !== 'defaultuser') {
                console.log(`üîß [„É¶„Éº„Ç∂„ÉºÂêçÂèñÂæó] Áí∞Â¢ÉÂ§âÊï∞„Åã„Çâ: ${envUsername}`);
                return envUsername;
            }
            // 3. „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºö„Ç®„É©„Éº„ÇíÊäï„Åí„Çã
            throw new Error('„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇdata/account-config.yaml„Åæ„Åü„ÅØÁí∞Â¢ÉÂ§âÊï∞X_USERNAME„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
        catch (error) {
            console.error('‚ùå [„É¶„Éº„Ç∂„ÉºÂêçÂèñÂæó„Ç®„É©„Éº]:', error);
            throw error;
        }
    }
    async cleanup() {
        await playwright_common_config_1.PlaywrightCommonSetup.cleanup(this.browser || undefined, this.context || undefined);
        this.browser = null;
        this.context = null;
    }
}
exports.PlaywrightAccountCollector = PlaywrightAccountCollector;
